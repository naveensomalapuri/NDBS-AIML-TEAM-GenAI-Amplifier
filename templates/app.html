<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GenAI Amplifier</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .drop-zone {
      border: 2px dashed #4b5563;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      background-color: #1f2937;
      transition: background-color 0.3s, border-color 0.3s;
      border-radius: 8px;
      color: #e5e7eb;
      font-size: 16px;
      position: relative;
    }
    .drop-zone.dragging {
      background-color: #374151;
      border-color: #60a5fa;
      color: #93c5fd;
    }
    .drop-zone.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background-color: #374151;
    }
    .notification-message {
      margin-top: 10px;
      font-size: 16px;
      text-align: center;
    }
    #next-button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
      font-weight: bold;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: not-allowed;
      transition: background-color 0.3s, cursor 0.3s;
      background-color: #3b82f6;
    }
    #next-button:enabled {
      cursor: pointer;
      background-color: #2563eb;
    }
    #next-button:hover:enabled {
      background-color: #1d4ed8;
    }
    .text-input-disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center p-6 space-y-6">

<!-- HEADER -->
<header class="w-full flex items-center justify-between px-6 mb-6 relative">
  <div class="absolute left-6">
    <!-- Menu button can go here if needed -->
  </div>
  <div class="mx-auto">
    <h1 class="text-3xl font-bold text-white text-center">GenAI Amplifier</h1>
  </div>
  <div class="absolute right-6">
    <!-- Logo from static folder -->
    <img src="/static/Logo_Global_NTT_DATA_Future_Blue_RGB.png" alt="NTT DATA Logo" class="h-14 w-auto object-contain" />
  </div>
</header>

  <!-- Tabs Navigation -->
  <div class="flex space-x-4 mb-4">
    <button id="tab1-btn" type="button" onclick="showTab('tab1')" class="tab-btn bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded">Home</button>
    <button id="tab2-btn" type="button" onclick="showTab('tab2')" class="tab-btn bg-gray-600 hover:bg-indigo-500 px-4 py-2 rounded" disabled>DEV Item Details</button>
    <button id="tab3-btn" type="button" onclick="showTab('tab3')" class="tab-btn bg-gray-600 hover:bg-indigo-500 px-4 py-2 rounded" disabled>Owner Details</button>
  </div>

  <form action="/add" method="post" id="mainForm">
    <!-- Tab 1: Home -->
    <div id="tab1" class="tab-content active w-full max-w-3xl bg-gray-800 p-6 rounded-xl shadow space-y-4">
      <label class="block text-lg text-white">Upload / Enter the Meeting Notes:</label>
      
      <!-- Text Input Section -->
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-300 mb-2">Type your meeting notes:</label>
          <textarea 
            id="text-input" 
            placeholder="Type your meeting notes here..."
            class="w-full h-32 bg-gray-700 text-white px-3 py-2 rounded border border-gray-600 resize-vertical focus:outline-none focus:ring-2 focus:ring-blue-500"
          ></textarea>
        </div>
        
        <div class="text-center text-gray-400">OR</div>
        
        <!-- File Drop Zone -->
        <div id="drop-zone" class="drop-zone">
          <p>Drag & drop your meeting notes (.txt) file here, or click to upload</p>
          <input id="file-input" type="file" class="hidden" accept=".txt" />
          <div id="notification" class="notification-message"></div>
        </div>
      </div>
      
      <div class="flex justify-center">
        <button 
          type="button" 
          id="next-button" 
          class="bg-blue-600 text-white px-4 py-2 rounded-md shadow-md hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-300 active:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed" 
          disabled
        >
          Next
        </button>
      </div>
    
      <!-- Load Existing WRICEF Button -->
      <div class="pt-4">
        <button 
          type="button" 
          id="load-existing-button" 
          class="bg-yellow-600 hover:bg-yellow-500 px-4 py-2 rounded text-white"
        >
          Load Existing DEV Item Details
        </button>
      </div>
    </div>

    <!-- Tab 2: WRICEF Details -->
    <div id="tab2" class="tab-content w-full max-w-4xl bg-gray-800 p-6 rounded-xl shadow space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="ricefw">Dev Item Type:</label>
          <select id="ricefw" name="ricefw" class="w-full bg-gray-700 text-white px-3 py-2 rounded">
            <option value="Interface">Interface</option>
            <option value="Enhancements">Enhancements</option>
            <option value="Reports">Reports</option>
            <option value="Forms">Forms</option>
            <option value="Workflow">Workflow</option>
          </select>
        </div>
        <div>
          <label for="customer">Customer: <span class="text-red-500">*</span></label>
          <input type="text" id="customer" name="customer" class="w-full bg-gray-700 text-white px-3 py-2 rounded" placeholder="Enter Customer Name" required />
        </div>
        <div>
          <label for="ricefw-number">Dev Item / Issue Number: <span class="text-red-500">*</span></label>
          <input type="text" id="ricefw-number" name="ricefw-number" class="w-full bg-gray-700 text-white px-3 py-2 rounded" placeholder="Enter RICEFW Number" required />
        </div>
        <div>
          <label for="module">Module(s):</label>
          <input type="text" id="module" name="module" class="w-full bg-gray-700 text-white px-3 py-2 rounded" placeholder="Enter Module(s)" />
        </div>
        <div>
          <label for="specification">Specification Name:</label>
          <input type="text" id="specification" name="specification" class="w-full bg-gray-700 text-white px-3 py-2 rounded" placeholder="Enter Specification Name" />
        </div>
        <div>
          <label for="description">Brief Description:</label>
          <input type="text" id="description" name="description" class="w-full bg-gray-700 text-white px-3 py-2 rounded" placeholder="Enter Brief Description" />
        </div>
        <div>
          <label for="related-ricefw">Related Dev Items:</label>
          <input type="text" id="related-ricefw" name="related-ricefw" class="w-full bg-gray-700 text-white px-3 py-2 rounded" placeholder="Enter Related WRICEF(s)" />
        </div>
        <div>
          <label for="created-by">Created By:</label>
          <input type="text" id="created-by" name="created-by" class="w-full bg-gray-700 text-white px-3 py-2 rounded" placeholder="Enter Your Name" />
        </div>
        <div>
          <label for="document-date">Document Date:</label>
          <input type="date" id="document-date" name="document-date" class="w-full bg-gray-700 text-white px-3 py-2 rounded" />
        </div>
        <div>
          <label for="completion-date">Target Completion Date:</label>
          <input type="date" id="completion-date" name="completion-date" class="w-full bg-gray-700 text-white px-3 py-2 rounded" />
        </div>
      </div>
      
      <!-- Instruction for user -->
      <div class="mt-4 text-right text-sm text-gray-400 italic">
        Click 'Continue' upon completion of the Owner Details section.
      </div>

      <div class="flex justify-end">
        <button 
          type="button" 
          id="next-to-owner-button" 
          class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded text-white disabled:bg-gray-400 disabled:cursor-not-allowed" 
          disabled
        >
          Next
        </button>
      </div>
    </div>

    <!-- Tab 3: Owner Details -->
    <div id="tab3" class="tab-content w-full max-w-5xl bg-gray-800 p-6 rounded-xl shadow space-y-4">
      <table class="w-full text-sm text-left text-white">
        <thead class="bg-gray-700 text-white">
          <tr>
            <th class="p-2">Role</th>
            <th class="p-2">Name</th>
            <th class="p-2">Company / Role</th>
            <th class="p-2">Email</th>
            <th class="p-2">Phone #</th>
          </tr>
        </thead>
        <tbody class="bg-gray-600">
          <tr>
            <td class="p-2">Client Owner (BPO)</td>
            <td><input type="text" name="client-owner-name" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter Name" /></td>
            <td><input type="text" name="client-owner-company" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter Company" /></td>
            <td><input type="email" name="client-owner-email" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter Email" /></td>
            <td><input type="text" name="client-owner-phone" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter Phone #" /></td>
          </tr>
          <tr>
            <td class="p-2">Functional Owner (Consultant)</td>
            <td><input type="text" name="functional-owner-name" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter Name" /></td>
            <td><input type="text" name="functional-owner-company" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter Company" /></td>
            <td><input type="email" name="functional-owner-email" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter Email" /></td>
            <td><input type="text" name="functional-owner-phone" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter Phone #" /></td>
          </tr>
          <tr>
            <td class="p-2">Technical Owner (Consultant)</td>
            <td><input type="text" name="technical-owner-name" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter Name" /></td>
            <td><input type="text" name="technical-owner-company" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter Company" /></td>
            <td><input type="email" name="technical-owner-email" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter Email" /></td>
            <td><input type="text" name="technical-owner-phone" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter Phone #" /></td>
          </tr>
          <tr>
            <td class="p-2">Developer</td>
            <td><input type="text" name="developer-name" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter Name" /></td>
            <td><input type="text" name="developer-company" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter Company" /></td>
            <td><input type="email" name="developer-email" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter Email" /></td>
            <td><input type="text" name="developer-phone" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter Phone #" /></td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Hidden input for file text -->
    <input type="hidden" name="fileText" id="file-text">

    <!-- Footer Continue Button -->
    <div class="fixed bottom-4 right-4">
      <button 
        type="button"
        id="continue-button"
        class="bg-indigo-600 hover:bg-indigo-500 px-6 py-3 rounded-xl font-semibold flex items-center justify-center space-x-2 disabled:bg-gray-400 disabled:cursor-not-allowed"
        disabled
      >
        <span>Continue</span>
        <svg class="w-5 h-5 text-white dark:text-gray-200" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5h12m0 0L9 1m4 4L9 9"/>
        </svg>
      </button>
    </div>
  </form>

  <!-- JavaScript -->
  <script>
    let isTextInputActive = false;
    let isFileInputActive = false;

    // Tab functionality
    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById(tabId).classList.add('active');
    }

    // File Upload and Drag/Drop Functionality
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const fileContentInput = document.getElementById('file-text');
    const nextButton = document.getElementById('next-button');
    const textInput = document.getElementById('text-input');
    const notification = document.getElementById('notification');
    const continueButton = document.getElementById('continue-button');
    const nextToOwnerButton = document.getElementById('next-to-owner-button');

    // Function to show notifications instead of pop-ups
    function showNotification(message, type) {
      notification.textContent = message;
      if (type === 'success') {
        notification.style.color = '#34d399'; // green in dark theme
      } else if (type === 'error') {
        notification.style.color = '#ef4444'; // red in dark theme
      } else {
        notification.style.color = '#e5e7eb'; // light gray in dark theme
      }
    }

    // Function to disable text input
    function disableTextInput() {
      textInput.disabled = true;
      textInput.classList.add('text-input-disabled');
      textInput.placeholder = "File upload is active - text input disabled";
    }

    // Function to enable text input
    function enableTextInput() {
      textInput.disabled = false;
      textInput.classList.remove('text-input-disabled');
      textInput.placeholder = "Type your meeting notes here...";
    }

    // Function to disable drop zone
    function disableDropZone() {
      dropZone.classList.add('disabled');
      dropZone.style.pointerEvents = 'none';
      dropZone.querySelector('p').textContent = "Text input is active - file upload disabled";
    }

    // Function to enable drop zone
    function enableDropZone() {
      dropZone.classList.remove('disabled');
      dropZone.style.pointerEvents = 'auto';
      dropZone.querySelector('p').textContent = "Drag & drop your meeting notes (.txt) file here, or click to upload";
    }

    // Function to check if required WRICEF fields are filled
    function checkWricefFields() {
      const customer = document.getElementById('customer').value.trim();
      const ricefwNumber = document.getElementById('ricefw-number').value.trim();
      
      if (customer && ricefwNumber) {
        nextToOwnerButton.disabled = false;
      } else {
        nextToOwnerButton.disabled = true;
      }
    }

    // Function to check if all fields are filled for continue button
    function checkAllFields() {
      const customer = document.getElementById('customer').value.trim();
      const ricefwNumber = document.getElementById('ricefw-number').value.trim();
      const meetingNotes = document.getElementById('file-text').value.trim();
      
      if (customer && ricefwNumber && meetingNotes) {
        continueButton.disabled = false;
      } else {
        continueButton.disabled = true;
      }
    }

    // When the drop zone is clicked, trigger file selection
    dropZone.addEventListener('click', () => {
      if (!dropZone.classList.contains('disabled')) {
        fileInput.click();
      }
    });

    dropZone.addEventListener('dragover', (event) => {
      if (!dropZone.classList.contains('disabled')) {
        event.preventDefault();
        dropZone.classList.add('dragging');
      }
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragging');
    });

    // Handle file drop
    dropZone.addEventListener('drop', async (event) => {
      if (!dropZone.classList.contains('disabled')) {
        event.preventDefault();
        dropZone.classList.remove('dragging');
        const file = event.dataTransfer.files[0];
        if (file && file.type === 'text/plain') {
          const text = await file.text();
          fileContentInput.value = encodeURIComponent(text);
          nextButton.disabled = false;
          isFileInputActive = true;
          isTextInputActive = false;
          disableTextInput();
          textInput.value = ''; // Clear text input
          showNotification('File Uploaded Successfully!', "success");
          checkAllFields();
        } else {
          showNotification('Please upload a valid .txt file.', "error");
        }
      }
    });

    // Handle file selection
    fileInput.addEventListener('change', async () => {
      const file = fileInput.files[0];
      if (file && file.type === 'text/plain') {
        const text = await file.text();
        fileContentInput.value = encodeURIComponent(text);
        nextButton.disabled = false;
        isFileInputActive = true;
        isTextInputActive = false;
        disableTextInput();
        textInput.value = ''; // Clear text input
        showNotification('File Uploaded Successfully!', "success");
        checkAllFields();
      } else {
        showNotification('Please upload a valid .txt file.', "error");
      }
    });

    // Listen for manual text input
    textInput.addEventListener('input', () => {
      const text = textInput.value.trim();
      if (text && !isFileInputActive) {
        fileContentInput.value = encodeURIComponent(text);
        nextButton.disabled = false;
        isTextInputActive = true;
        disableDropZone();
        checkAllFields();
      } else if (!text && !isFileInputActive) {
        fileContentInput.value = '';
        nextButton.disabled = true;
        isTextInputActive = false;
        enableDropZone();
        checkAllFields();
      }
    });

    // Add event listeners for WRICEF required fields
    document.getElementById('customer').addEventListener('input', () => {
      checkWricefFields();
      checkAllFields();
    });
    
    document.getElementById('ricefw-number').addEventListener('input', () => {
      checkWricefFields();
      checkAllFields();
    });

    // Function to save data to MongoDB
    async function saveToMongoDB() {
      const formData = new FormData(document.getElementById('mainForm'));
      // Convert FormData to a plain object
      const data = Object.fromEntries(formData.entries());
      // Transform keys: replace dashes with underscores
      const transformedData = {};
      for (const [key, value] of Object.entries(data)) {
        transformedData[key.replace(/-/g, "_")] = value;
      }
      
      try {
        const response = await fetch('/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(transformedData)
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('Data saved to MongoDB:', result);
          showNotification('Data saved successfully!', 'success');
          return true;
        } else {
          showNotification('Error saving data. Please try again.', 'error');
          return false;
        }
      } catch (error) {
        console.error("Error saving to MongoDB:", error);
        showNotification('Network error. Please check your connection.', 'error');
        return false;
      }
    }

    // Submit button functionality - REMOVED

    // Next button functionality (Home to WRICEF Details)
    nextButton.addEventListener('click', () => {
      const meetingNotes = fileContentInput.value.trim();
      if (meetingNotes) {
        showTab('tab2');
        showNotification('Moved to WRICEF Details', 'success');

        // Enable DEV Item Details tab after Home
        document.getElementById("tab2-btn").disabled = false;
        document.getElementById("tab2-btn").classList.remove("bg-gray-600");
        document.getElementById("tab2-btn").classList.add("bg-indigo-600");

      } else {
        showNotification('Please enter meeting notes or upload a file', 'error');
      }
    });

    // Next button functionality (WRICEF Details to Owner Details)
    nextToOwnerButton.addEventListener('click', () => {
      const customer = document.getElementById('customer').value.trim();
      const ricefwNumber = document.getElementById('ricefw-number').value.trim();
      
      if (customer && ricefwNumber) {
        showTab('tab3');
        showNotification('Moved to Owner Details', 'success');

        // Enable Owner Details tab after WRICEF
        document.getElementById("tab3-btn").disabled = false;
        document.getElementById("tab3-btn").classList.remove("bg-gray-600");
        document.getElementById("tab3-btn").classList.add("bg-indigo-600");

      } else {
        showNotification('Please fill in Customer and WRICEF Number fields', 'error');
      }
    });

    // Load existing WRICEF button
    document.getElementById('load-existing-button').addEventListener('click', () => {
      window.location.href = '/listofwricefs';
    });

    // Continue button functionality
    continueButton.addEventListener('click', async () => {
      const customer = document.getElementById('customer').value.trim();
      const ricefwNumber = document.getElementById('ricefw-number').value.trim();
      const meetingNotes = document.getElementById('file-text').value.trim();
      
      if (!customer || !ricefwNumber || !meetingNotes) {
        showNotification('Please fill in all required fields and ensure meeting notes are entered', 'error');
        return;
      }
      
      // Save all data to MongoDB before redirecting
      const savedSuccessfully = await saveToMongoDB();
      
      if (savedSuccessfully) {
        // Small delay to ensure save completed, then redirect
        setTimeout(() => {
          redirectToSuccess();
        }, 500);
      }
    });

    // Redirect to the success page with parameters
    function redirectToSuccess() {
      let name = document.getElementById("customer").value;
      let meetingNotes = document.getElementById("file-text").value;
      let ricefwNumber = document.getElementById("ricefw-number").value;
      let wricef_type = document.getElementById("ricefw").value;
      
      // Redirect to success page
      window.location.href = `/success?name=${encodeURIComponent(name)}&meetingNotes=${encodeURIComponent(meetingNotes)}&ricefwNumber=${encodeURIComponent(ricefwNumber)}&wricef_type=${encodeURIComponent(wricef_type)}`;
    }

    // Set current date as default for date fields
    document.addEventListener('DOMContentLoaded', () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('document-date').value = today;
    });
  </script>
</body>
</html>